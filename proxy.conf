server {
    # Railway передаёт HTTP трафик внутрь контейнера
    listen 8080;
    listen [::]:8080; # безопасно оставить, но IPv6 отключён выше

    server_name _;

    # Основной прокси на Xray (httpupgrade inbound)
    location / {
        proxy_pass http://backend_vless/;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # !!! Укажи явно какой HOST передавать !!!
        # вариант 1 — если Xray ожидает repl-production...
        proxy_set_header Host repl-production.up.railway.app;
        # вариант 2 — если ожидает main.up.railway.app
        # proxy_set_header Host main.up.railway.app;

        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Real-IP $remote_addr;

        # отключаем буферизацию и увеличиваем таймауты
        proxy_read_timeout 86400;
        proxy_send_timeout 86400;
        proxy_buffering off;

        # форсируем IPv4
        proxy_bind 0.0.0.0;
    }
}
